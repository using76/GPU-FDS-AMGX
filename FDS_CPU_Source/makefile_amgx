# Makefile for Fire Dynamics Simulator (FDS) with NVIDIA AmgX GPU Support
#
# This makefile extends the standard FDS build to include GPU-accelerated
# pressure solver using NVIDIA AmgX library.
#
# Usage:
#   make -f makefile_amgx impi_intel_linux_amgx
#   make -f makefile_amgx impi_intel_linux_amgx_openmp
#   make -f makefile_amgx impi_intel_linux_amgx_db
#
# Environment Variables Required:
#   AMGX_HOME  - Path to AmgX installation (e.g., /path/to/AMGX/build)
#   CUDA_HOME  - Path to CUDA toolkit (e.g., /usr/local/cuda)
#   MKLROOT    - Path to Intel MKL (standard FDS requirement)
#
# Example:
#   export AMGX_HOME=/home/user/AMGX/build
#   export CUDA_HOME=/usr/local/cuda
#   make -f makefile_amgx impi_intel_linux_amgx_openmp

VPATH = ../Source:../FDS_CPU_Source

# 3rd party library versions
HYPRE_VERSION=v2.33.0
SUNDIALS_VERSION=v6.7.0

ifeq ($(shell echo "check_quotes"),"check_quotes")
# windows
  GIT_HASH := $(shell ..\Scripts\githash)
  GIT_STAT := $(shell ..\Scripts\gitstat)
  GIT_DATE := $(shell ..\Scripts\gitlog)
  GIT_BRANCH := $(shell ..\Scripts\gitbranch)
  BUILD_DATE := $(shell powershell -Command "(Get-Date).ToString('ddd-MM/dd/yyyy-hh:mm-tt')")
else
# linux/osx
  SHELL:=/bin/bash
  GIT_HASH := $(shell git describe --long --abbrev=7 2>/dev/null || echo "unknown")
  ifeq ("$(shell git diff --shortstat $(VPATH)/*.f90 2>/dev/null)","")
    GIT_STAT :=
  else
    GIT_STAT := -dirty
  endif
  GIT_DATE := $(shell git log -1 --format=%cd 2>/dev/null || echo "unknown")
  GIT_BRANCH := $(shell git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
  BUILD_DATE := $(shell date "+%b %d, %Y  %T")
endif

HYPRE_INFO=-DHYPRE_PP=\"$(HYPRE_VERSION)\"
SUNDIALS_INFO=-DSUNDIALS_PP=\"$(SUNDIALS_VERSION)\"

GITINFO_BASE=-DGITHASH_PP=\"$(GIT_HASH)$(GIT_STAT)-$(GIT_BRANCH)\" -DGITDATE_PP=\""$(GIT_DATE)\""
GITINFO=-fpp $(GITINFO_BASE) -DBUILDDATE_PP=\""$(BUILD_DATE)\""
GITINFOGNU=-cpp $(GITINFO_BASE) -DBUILDDATE_PP=\""$(BUILD_DATE)\""

# MKL Configuration (same as standard FDS)
FFLAGSMKL =
LFLAGSMKL_INTEL =
LFLAGSMKL_INTEL_OPENMP =
LFLAGSMKL_GNU_OPENMP =

FFLAGS_SUNDIALS =
LFLAGS_SUNDIALS =
FFLAGS_HYPRE =
LFLAGS_HYPRE =

ifdef MKLROOT
MKL_DIR_UNIX  := $(subst \,/,$(MKLROOT))
MKL_DIR_INTEL := $(MKL_DIR_UNIX)/lib/intel64
MKL_DIR_BASE  := $(MKL_DIR_UNIX)/lib
MKL_BLA_LIB   := mkl_blacs_intelmpi_lp64
MKL_BLA_PATH_A := "$(MKL_DIR_INTEL)/lib$(MKL_BLA_LIB).a"
MKL_BLA_PATH_LIB := "$(MKL_DIR_INTEL)/$(MKL_BLA_LIB).lib"
ifneq (,$(wildcard $(MKL_BLA_PATH_A) $(MKL_BLA_PATH_LIB)))
    MKLLIBDIR := $(MKL_DIR_INTEL)
else
    MKLLIBDIR := $(MKL_DIR_BASE)
endif
$(info MKLLIBDIR = $(MKLLIBDIR))

ifeq ($(shell echo "check_quotes"),"check_quotes")
  # windows
  FFLAGSMKL = -DWITH_MKL /I"$(MKLROOT)\include"
  COMMON_MKL_LIBS = "$(MKLLIBDIR)\mkl_intel_lp64.lib" "$(MKLLIBDIR)\mkl_core.lib" "$(MKLLIBDIR)\mkl_blacs_intelmpi_lp64.lib"
  LFLAGSMKL_INTEL = $(COMMON_MKL_LIBS) "$(MKLLIBDIR)\mkl_sequential.lib"
  LFLAGSMKL_INTEL_OPENMP = $(COMMON_MKL_LIBS) "$(MKLLIBDIR)\mkl_intel_thread.lib"
else
  # linux
  FFLAGSMKL = -DWITH_MKL -I$(MKLROOT)/include
  COMMON_MKL_LIBS = ${MKLLIBDIR}/libmkl_intel_lp64.a ${MKLLIBDIR}/libmkl_core.a -lpthread -lm -ldl
  COMMON_MKL_INTEL_LIBS = ${COMMON_MKL_LIBS} ${MKLLIBDIR}/libmkl_blacs_intelmpi_lp64.a
  LFLAGSMKL_INTEL = -Wl,--start-group ${COMMON_MKL_INTEL_LIBS} ${MKLLIBDIR}/libmkl_sequential.a -Wl,--end-group
  LFLAGSMKL_INTEL_OPENMP = -Wl,--start-group ${COMMON_MKL_INTEL_LIBS} ${MKLLIBDIR}/libmkl_intel_thread.a -liomp5 -Wl,--end-group
  COMMON_MKL_GNU_LIBS = ${MKLLIBDIR}/libmkl_gf_lp64.a ${MKLLIBDIR}/libmkl_core.a ${MKLLIBDIR}/libmkl_blacs_openmpi_lp64.a -lpthread -lm -ldl
  LFLAGSMKL_GNU_OPENMP = -Wl,--start-group ${COMMON_MKL_GNU_LIBS} ${MKLLIBDIR}/libmkl_gnu_thread.a -lgomp -Wl,--end-group
endif
endif

ifdef SUNDIALS_HOME
   FFLAGS_SUNDIALS = -DWITH_SUNDIALS ${SUNDIALS_INFO} -I"${SUNDIALS_HOME}/fortran"
   LFLAGS_SUNDIALS = ${SUNDIALS_HOME}/lib/libsundials_fcvode_mod.a ${SUNDIALS_HOME}/lib/libsundials_fnvecserial_mod.a ${SUNDIALS_HOME}/lib/libsundials_cvode.a
endif

ifdef HYPRE_HOME
   FFLAGS_HYPRE = -DWITH_HYPRE ${HYPRE_INFO} -I${HYPRE_HOME}/include
   LFLAGS_HYPRE = -L${HYPRE_HOME}/lib -lHYPRE -lm
endif

# =============================================================================
# AmgX GPU Configuration
# =============================================================================

# Default paths (can be overridden)
AMGX_HOME ?= /usr/local/amgx
CUDA_HOME ?= /usr/local/cuda

# Check if AmgX is available
ifdef AMGX_HOME
    AMGX_AVAILABLE := $(shell test -f $(AMGX_HOME)/libamgx.a && echo "yes" || echo "no")
    ifeq ($(AMGX_AVAILABLE),yes)
        $(info AmgX found at $(AMGX_HOME))

        # AmgX compile flags
        FFLAGS_AMGX = -DWITH_AMGX -I$(AMGX_HOME)/../base/include -I$(AMGX_HOME)/../include

        # AmgX link flags
        # Static linking (preferred for portability)
        LFLAGS_AMGX_STATIC = $(AMGX_HOME)/libamgx.a
        # Dynamic linking
        LFLAGS_AMGX_SHARED = -L$(AMGX_HOME) -lamgxsh -Wl,-rpath,$(AMGX_HOME)

        # Default to static linking
        LFLAGS_AMGX = $(LFLAGS_AMGX_STATIC)

        # CUDA libraries (required by AmgX)
        CUDA_LIBS = -L$(CUDA_HOME)/lib64 -lcudart -lcublas -lcusparse -lcusolver -lnvToolsExt
        CUDA_LIBS += -Wl,-rpath,$(CUDA_HOME)/lib64

        # NVML library for GPU monitoring (optional but recommended)
        NVML_AVAILABLE := $(shell test -f $(CUDA_HOME)/lib64/libnvidia-ml.so && echo "yes" || echo "no")
        ifeq ($(NVML_AVAILABLE),yes)
            CUDA_LIBS += -lnvidia-ml
            CFLAGS_NVML = -DWITH_NVML
            $(info NVML library found - GPU monitoring enabled)
        else
            CFLAGS_NVML =
            $(warning NVML library not found - GPU monitoring limited to memory usage only)
        endif

        # C compiler for AmgX wrapper
        CC_AMGX = gcc
        CFLAGS_AMGX = -O2 -fPIC -I$(AMGX_HOME)/../base/include -I$(AMGX_HOME)/../include -I$(CUDA_HOME)/include $(CFLAGS_NVML)

        # NVCC compiler for CUDA kernels
        NVCC = $(CUDA_HOME)/bin/nvcc
        NVCCFLAGS = -O3 -arch=sm_70 --use_fast_math -Xcompiler -fPIC -I$(CUDA_HOME)/include
        NVCCFLAGS_DB = -O0 -g -G -arch=sm_70 -Xcompiler -fPIC -I$(CUDA_HOME)/include

        # GPU kernel compile flags
        FFLAGS_GPU_KERNELS = -DWITH_GPU_KERNELS
    else
        $(warning AmgX library not found at $(AMGX_HOME)/libamgx.a)
        $(warning GPU acceleration will not be available)
    endif
else
    $(warning AMGX_HOME not set - GPU acceleration will not be available)
endif

# =============================================================================
# Object Files
# =============================================================================

# Standard FDS objects
obj_mpi = prec.o cons.o chem.o prop.o devc.o type.o data.o mesh.o func.o gsmv.o smvv.o rcal.o turb.o soot.o \
          pois.o geom.o ccib.o radi.o part.o vege.o ctrl.o hvac.o mass.o imkl.o \
          wall.o fire.o velo.o pres.o init.o dump.o read.o divg.o main.o

# AmgX-specific objects (C wrapper and Fortran interface)
obj_amgx = amgx_c_wrapper.o amgx_fortran.o amgx_validation.o

# GPU kernel objects (CUDA kernels for diffusion/advection)
obj_gpu_kernels = gpu_kernels.o gpu_c_wrapper.o gpu_fortran.o gpu_data_manager.o gpu_data_fortran.o

# Combined objects for AmgX build
obj_mpi_amgx = $(obj_mpi) $(obj_amgx)

# Combined objects for full GPU build (AmgX + GPU kernels)
obj_mpi_full_gpu = $(obj_mpi) $(obj_amgx) $(obj_gpu_kernels)

objwin_mpi = $(obj_mpi:.o=.obj)
objwin_mpi_amgx = $(obj_mpi_amgx:.o=.obj)

# =============================================================================
# General Rules
# =============================================================================

no_target:
	@echo "******** You did not specify a make target ********"
	@echo "Available AmgX targets:"
	@echo "  impi_intel_linux_amgx        - Intel MPI + Intel compiler + AmgX"
	@echo "  impi_intel_linux_amgx_openmp - Intel MPI + Intel compiler + AmgX + OpenMP"
	@echo "  impi_intel_linux_amgx_db     - Debug build"
	@echo "  ompi_gnu_linux_amgx          - Open MPI + GNU compiler + AmgX"
	@echo "  ompi_gnu_linux_amgx_db       - Debug build"
	@echo ""
	@echo "Required environment variables:"
	@echo "  AMGX_HOME - Path to AmgX build directory"
	@echo "  CUDA_HOME - Path to CUDA toolkit"
	@echo "  MKLROOT   - Path to Intel MKL"

setup:
%.o : %.mod

.SUFFIXES: .f90 .o .c

.f90.o:
	$(FCOMPL) -c $(FFLAGS) $<

.c.o:
	$(CC_AMGX) -c $(CFLAGS_AMGX) $<

# CUDA compilation rule
%.o : %.cu
	$(NVCC) -c $(NVCCFLAGS) $< -o $@

# OpenMP flags for specific files
ccib.o: FFLAGS += $(FOPENMPFLAGS)
divg.o: FFLAGS += $(FOPENMPFLAGS)
func.o: FFLAGS += $(FOPENMPFLAGS)
mass.o: FFLAGS += $(FOPENMPFLAGS)
pres.o: FFLAGS += $(FOPENMPFLAGS)
turb.o: FFLAGS += $(FOPENMPFLAGS)
velo.o: FFLAGS += $(FOPENMPFLAGS)
radi.o: FFLAGS += $(FOPENMPFLAGS)
wall.o: FFLAGS += $(FOPENMPFLAGS)
main.o: FFLAGS += $(FOPENMPFLAGS)

# =============================================================================
# AmgX Build Targets - Intel MPI + Intel Fortran
# =============================================================================

impi_intel_linux_amgx : FFLAGS = -O2 -ipo -no-wrap-margin $(GITINFO) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX) -DUSE_IFPORT
impi_intel_linux_amgx : LFLAGSMKL = $(LFLAGSMKL_INTEL) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
impi_intel_linux_amgx : FCOMPL = $(COMP_FC)
impi_intel_linux_amgx : obj = fds_impi_intel_linux_amgx
impi_intel_linux_amgx : setup $(obj_mpi_amgx)
	$(FCOMPL) $(FFLAGS) -o $(obj) $(obj_mpi_amgx) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

impi_intel_linux_amgx_openmp : FFLAGS = -O2 -ipo -no-wrap-margin $(GITINFO) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX) -DUSE_IFPORT
impi_intel_linux_amgx_openmp : LFLAGSMKL = $(LFLAGSMKL_INTEL_OPENMP) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
impi_intel_linux_amgx_openmp : FCOMPL = $(COMP_FC)
impi_intel_linux_amgx_openmp : FOPENMPFLAGS = -qopenmp
impi_intel_linux_amgx_openmp : obj = fds_impi_intel_linux_amgx_openmp
impi_intel_linux_amgx_openmp : setup $(obj_mpi_amgx)
	$(FCOMPL) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi_amgx) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

impi_intel_linux_amgx_db : FFLAGS = -check all -warn all -diag-error=remark,warn,error -O0 -g -traceback -fpe0 -nofltconsistency -stand:f23 -no-wrap-margin $(GITINFO) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX) -DUSE_IFPORT
impi_intel_linux_amgx_db : LFLAGSMKL = $(LFLAGSMKL_INTEL) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
impi_intel_linux_amgx_db : FCOMPL = $(COMP_FC)
impi_intel_linux_amgx_db : obj = fds_impi_intel_linux_amgx_db
impi_intel_linux_amgx_db : setup $(obj_mpi_amgx)
	$(FCOMPL) $(FFLAGS) -o $(obj) $(obj_mpi_amgx) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

impi_intel_linux_amgx_openmp_db : FFLAGS = -check all -warn all -diag-error=remark,warn,error -O0 -g -traceback -fpe0 -nofltconsistency -stand:f23 -no-wrap-margin $(GITINFO) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX) -DUSE_IFPORT
impi_intel_linux_amgx_openmp_db : LFLAGSMKL = $(LFLAGSMKL_INTEL_OPENMP) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
impi_intel_linux_amgx_openmp_db : FCOMPL = $(COMP_FC)
impi_intel_linux_amgx_openmp_db : FOPENMPFLAGS = -qopenmp
impi_intel_linux_amgx_openmp_db : obj = fds_impi_intel_linux_amgx_openmp_db
impi_intel_linux_amgx_openmp_db : setup $(obj_mpi_amgx)
	$(FCOMPL) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi_amgx) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

# =============================================================================
# AmgX Build Targets - Open MPI + GNU Compilers
# =============================================================================

ompi_gnu_linux_amgx : FFLAGS = -O3 -std=f2018 -frecursive -ffpe-summary=none -fall-intrinsics $(GITINFOGNU) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX)
ompi_gnu_linux_amgx : LFLAGSMKL = $(LFLAGSMKL_GNU_OPENMP) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
ompi_gnu_linux_amgx : FCOMPL = $(COMP_FC)
ompi_gnu_linux_amgx : FOPENMPFLAGS = -fopenmp
ompi_gnu_linux_amgx : obj = fds_ompi_gnu_linux_amgx
ompi_gnu_linux_amgx : setup $(obj_mpi_amgx)
	$(FCOMPL) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi_amgx) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

ompi_gnu_linux_amgx_db : FFLAGS = -O0 -std=f2018 -ggdb -finit-real=snan -finit-integer=-999999 -Wall -Werror -Wunused-parameter -Wcharacter-truncation -Wno-target-lifetime -fcheck=all -fbacktrace -ffpe-trap=invalid,zero,overflow -frecursive -ffpe-summary=none -fall-intrinsics -fbounds-check $(GITINFOGNU) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX)
ompi_gnu_linux_amgx_db : LFLAGSMKL = $(LFLAGSMKL_GNU_OPENMP) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
ompi_gnu_linux_amgx_db : FCOMPL = $(COMP_FC)
ompi_gnu_linux_amgx_db : FOPENMPFLAGS = -fopenmp
ompi_gnu_linux_amgx_db : obj = fds_ompi_gnu_linux_amgx_db
ompi_gnu_linux_amgx_db : setup $(obj_mpi_amgx)
	$(FCOMPL) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi_amgx) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

# =============================================================================
# Full GPU Build Targets (AmgX + GPU Kernels for Advection/Diffusion)
# =============================================================================

# GNU compiler with full GPU acceleration
ompi_gnu_linux_full_gpu : FFLAGS = -O3 -std=f2018 -frecursive -ffpe-summary=none -fall-intrinsics $(GITINFOGNU) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX) $(FFLAGS_GPU_KERNELS)
ompi_gnu_linux_full_gpu : LFLAGSMKL = $(LFLAGSMKL_GNU_OPENMP) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
ompi_gnu_linux_full_gpu : FCOMPL = $(COMP_FC)
ompi_gnu_linux_full_gpu : FOPENMPFLAGS = -fopenmp
ompi_gnu_linux_full_gpu : obj = fds_ompi_gnu_linux_full_gpu
ompi_gnu_linux_full_gpu : setup $(obj_mpi_full_gpu)
	$(FCOMPL) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi_full_gpu) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

ompi_gnu_linux_full_gpu_db : FFLAGS = -O0 -std=f2018 -ggdb -finit-real=snan -finit-integer=-999999 -Wall -Wno-error -Wunused-parameter -Wcharacter-truncation -Wno-target-lifetime -fcheck=all -fbacktrace -ffpe-trap=invalid,zero,overflow -frecursive -ffpe-summary=none -fall-intrinsics -fbounds-check $(GITINFOGNU) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX) $(FFLAGS_GPU_KERNELS)
ompi_gnu_linux_full_gpu_db : LFLAGSMKL = $(LFLAGSMKL_GNU_OPENMP) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
ompi_gnu_linux_full_gpu_db : FCOMPL = $(COMP_FC)
ompi_gnu_linux_full_gpu_db : FOPENMPFLAGS = -fopenmp
ompi_gnu_linux_full_gpu_db : NVCCFLAGS = $(NVCCFLAGS_DB)
ompi_gnu_linux_full_gpu_db : obj = fds_ompi_gnu_linux_full_gpu_db
ompi_gnu_linux_full_gpu_db : setup $(obj_mpi_full_gpu)
	$(FCOMPL) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi_full_gpu) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

# Intel compiler with full GPU acceleration
impi_intel_linux_full_gpu : FFLAGS = -O2 -ipo -no-wrap-margin $(GITINFO) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX) $(FFLAGS_GPU_KERNELS) -DUSE_IFPORT
impi_intel_linux_full_gpu : LFLAGSMKL = $(LFLAGSMKL_INTEL_OPENMP) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
impi_intel_linux_full_gpu : FCOMPL = $(COMP_FC)
impi_intel_linux_full_gpu : FOPENMPFLAGS = -qopenmp
impi_intel_linux_full_gpu : obj = fds_impi_intel_linux_full_gpu
impi_intel_linux_full_gpu : setup $(obj_mpi_full_gpu)
	$(FCOMPL) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi_full_gpu) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

impi_intel_linux_full_gpu_db : FFLAGS = -check all -warn all -diag-error=remark,warn,error -O0 -g -traceback -fpe0 -nofltconsistency -stand:f23 -no-wrap-margin $(GITINFO) $(FFLAGSMKL) $(FFLAGS_HYPRE) $(FFLAGS_SUNDIALS) $(FFLAGS_AMGX) $(FFLAGS_GPU_KERNELS) -DUSE_IFPORT
impi_intel_linux_full_gpu_db : LFLAGSMKL = $(LFLAGSMKL_INTEL_OPENMP) $(LFLAGS_HYPRE) $(LFLAGS_SUNDIALS)
impi_intel_linux_full_gpu_db : FCOMPL = $(COMP_FC)
impi_intel_linux_full_gpu_db : FOPENMPFLAGS = -qopenmp
impi_intel_linux_full_gpu_db : NVCCFLAGS = $(NVCCFLAGS_DB)
impi_intel_linux_full_gpu_db : obj = fds_impi_intel_linux_full_gpu_db
impi_intel_linux_full_gpu_db : setup $(obj_mpi_full_gpu)
	$(FCOMPL) $(FFLAGS) $(FOPENMPFLAGS) -o $(obj) $(obj_mpi_full_gpu) $(LFLAGSMKL) $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

# =============================================================================
# Unit Test Target
# =============================================================================

test_amgx : FFLAGS = -O0 -g -traceback $(FFLAGS_AMGX)
test_amgx : FCOMPL = $(COMP_FC)
test_amgx : CC_AMGX = gcc
test_amgx : amgx_c_wrapper.o amgx_fortran.o amgx_validation.o amgx_unit_test.o
	$(FCOMPL) $(FFLAGS) -o test_amgx amgx_c_wrapper.o amgx_fortran.o amgx_validation.o amgx_unit_test.o $(LFLAGS_AMGX) $(CUDA_LIBS) -lstdc++

# =============================================================================
# Object Dependencies
# =============================================================================

prec.o :
imkl.o :
cons.o : prec.o
chem.o : cons.o func.o
prop.o : prec.o
devc.o : prec.o
type.o : prec.o cons.o imkl.o
data.o : prec.o func.o cons.o prop.o
rcal.o : func.o prec.o cons.o
mesh.o : prec.o type.o
func.o : prec.o prop.o cons.o type.o mesh.o devc.o
gsmv.o : prec.o func.o cons.o mesh.o
smvv.o : geom.o prec.o func.o cons.o data.o
turb.o : prec.o func.o cons.o mesh.o
soot.o : prec.o mesh.o cons.o func.o turb.o
pois.o : prec.o cons.o
geom.o : gsmv.o func.o prec.o cons.o type.o mesh.o turb.o imkl.o data.o
ccib.o : gsmv.o func.o prec.o cons.o type.o mesh.o turb.o geom.o
radi.o : func.o prec.o cons.o type.o mesh.o rcal.o geom.o
part.o : func.o prec.o cons.o type.o mesh.o devc.o data.o geom.o soot.o ccib.o
vege.o : func.o prec.o cons.o type.o mesh.o geom.o
ctrl.o : prec.o cons.o type.o mesh.o func.o
hvac.o : func.o prec.o cons.o type.o mesh.o ctrl.o data.o geom.o
mass.o : func.o prec.o cons.o type.o mesh.o turb.o soot.o geom.o ccib.o
wall.o : func.o prec.o cons.o type.o mesh.o hvac.o mass.o soot.o geom.o ccib.o
fire.o : func.o prec.o cons.o type.o mesh.o mass.o soot.o radi.o chem.o
velo.o : func.o prec.o cons.o type.o mesh.o turb.o geom.o ccib.o gpu_fortran.o
pres.o : func.o prec.o cons.o type.o mesh.o pois.o velo.o geom.o ccib.o imkl.o amgx_fortran.o amgx_validation.o
init.o : func.o prec.o cons.o type.o mesh.o devc.o radi.o pois.o data.o pres.o geom.o
dump.o : func.o prec.o cons.o type.o mesh.o devc.o smvv.o turb.o data.o radi.o soot.o geom.o ccib.o fire.o
read.o : func.o prec.o cons.o type.o mesh.o devc.o ctrl.o radi.o hvac.o data.o geom.o mass.o soot.o prop.o
divg.o : func.o prec.o cons.o type.o mesh.o mass.o ccib.o gpu_fortran.o
main.o : func.o prec.o cons.o type.o mesh.o devc.o smvv.o mass.o divg.o velo.o wall.o fire.o radi.o part.o vege.o dump.o read.o init.o pres.o pois.o ctrl.o turb.o hvac.o data.o geom.o ccib.o soot.o prop.o chem.o amgx_fortran.o gpu_fortran.o gpu_data_fortran.o

# AmgX module dependencies
amgx_fortran.o : prec.o
amgx_validation.o : prec.o
amgx_c_wrapper.o :
amgx_unit_test.o : amgx_fortran.o amgx_validation.o

# GPU kernel module dependencies
gpu_kernels.o :
gpu_data_manager.o :
gpu_c_wrapper.o : gpu_kernels.o gpu_data_manager.o
gpu_data_fortran.o : prec.o
gpu_fortran.o : prec.o gpu_data_fortran.o

# =============================================================================
# Clean Targets
# =============================================================================

.PHONY : clean
clean:
	-rm -f *.o *.mod

.PHONY : clean_amgx
clean_amgx:
	-rm -f amgx_c_wrapper.o amgx_fortran.o amgx_validation.o amgx_unit_test.o
	-rm -f fds_*_amgx* test_amgx

.PHONY : clean_gpu
clean_gpu:
	-rm -f gpu_kernels.o gpu_c_wrapper.o gpu_fortran.o gpu_data_manager.o gpu_data_fortran.o
	-rm -f fds_*_full_gpu*

.PHONY : cleanall
cleanall: clean clean_amgx
	-rm -f fds_*

# =============================================================================
# Help Target
# =============================================================================

.PHONY : help
help:
	@echo "FDS with NVIDIA AmgX GPU Solver Makefile"
	@echo ""
	@echo "Build targets (AmgX pressure solver only):"
	@echo "  impi_intel_linux_amgx         - Release build (Intel MPI + Intel Fortran)"
	@echo "  impi_intel_linux_amgx_openmp  - Release build with OpenMP"
	@echo "  impi_intel_linux_amgx_db      - Debug build"
	@echo "  impi_intel_linux_amgx_openmp_db - Debug build with OpenMP"
	@echo "  ompi_gnu_linux_amgx           - Release build (Open MPI + GNU)"
	@echo "  ompi_gnu_linux_amgx_db        - Debug build (Open MPI + GNU)"
	@echo ""
	@echo "Build targets (Full GPU: AmgX + Advection/Diffusion kernels):"
	@echo "  ompi_gnu_linux_full_gpu       - Release build (Open MPI + GNU + CUDA kernels)"
	@echo "  ompi_gnu_linux_full_gpu_db    - Debug build (Open MPI + GNU + CUDA kernels)"
	@echo "  impi_intel_linux_full_gpu     - Release build (Intel MPI + Intel + CUDA kernels)"
	@echo "  impi_intel_linux_full_gpu_db  - Debug build (Intel MPI + Intel + CUDA kernels)"
	@echo ""
	@echo "Test targets:"
	@echo "  test_amgx                     - Build unit tests"
	@echo ""
	@echo "Clean targets:"
	@echo "  clean       - Remove object and module files"
	@echo "  clean_amgx  - Remove AmgX-specific files"
	@echo "  clean_gpu   - Remove GPU kernel files"
	@echo "  cleanall    - Remove all generated files"
	@echo ""
	@echo "Environment variables:"
	@echo "  AMGX_HOME   - AmgX installation directory (required)"
	@echo "  CUDA_HOME   - CUDA toolkit directory (required)"
	@echo "  MKLROOT     - Intel MKL directory (required for Intel builds)"
	@echo "  COMP_FC     - Fortran compiler wrapper (e.g., mpiifort, mpifort)"
	@echo ""
	@echo "Example usage:"
	@echo "  export AMGX_HOME=/path/to/AMGX/build"
	@echo "  export CUDA_HOME=/usr/local/cuda"
	@echo "  export COMP_FC=mpifort"
	@echo "  make -f makefile_amgx ompi_gnu_linux_full_gpu"
